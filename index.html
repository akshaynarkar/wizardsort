<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metricsi.de Clone | Stock Screener</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CSS VARIABLES & THEMES --- */
        :root {
            --bg-color: #f4f6f8;
            --panel-bg: #ffffff;
            --text-main: #1a1a1a;
            --text-muted: #666;
            --accent: #2962ff; /* Corporate Blue */
            --border: #e0e0e0;
            --green: #00c853;
            --red: #d50000;
            --shadow: 0 2px 8px rgba(0,0,0,0.05);
            --font-stack: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        [data-theme="dark"] {
            --bg-color: #0f111a;
            --panel-bg: #1e212b;
            --text-main: #e0e0e0;
            --text-muted: #8b949e;
            --accent: #448aff;
            --border: #2f3640;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; transition: background 0.3s, color 0.3s; }
        
        body {
            font-family: var(--font-stack);
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 250px;
            background-color: var(--panel-bg);
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 40px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover { background-color: var(--bg-color); color: var(--accent); }
        .nav-item.active { background-color: var(--bg-color); color: var(--accent); border-left: 3px solid var(--accent); }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* --- TOP BAR (Search + Bulb) --- */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .search-container {
            position: relative;
            width: 400px;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            border-radius: 25px;
            border: 1px solid var(--border);
            background: var(--panel-bg);
            color: var(--text-main);
            font-size: 0.9rem;
            outline: none;
        }

        .search-input:focus { border-color: var(--accent); }

        .suggestions {
            position: absolute;
            top: 45px;
            left: 0;
            width: 100%;
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            z-index: 100;
            display: none;
            box-shadow: var(--shadow);
        }

        .suggestion-item {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }
        .suggestion-item:hover { background: var(--bg-color); }

        .theme-toggle {
            cursor: pointer;
            font-size: 1.2rem;
            padding: 10px;
            background: var(--panel-bg);
            border-radius: 50%;
            border: 1px solid var(--border);
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- PAGES --- */
        .page { display: none; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS & GRID --- */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .card h3 { margin-top: 0; color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .metric-value { font-size: 2rem; font-weight: 700; margin: 10px 0; }

        /* --- WIZARD EYE SPECIFICS --- */
        .analyst-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .buy { background: rgba(0, 200, 83, 0.1); color: var(--green); }
        .hold { background: rgba(255, 193, 7, 0.1); color: #ffc107; }

        /* --- FORTUNE MANAGER SPECIFICS --- */
        .controls-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-end;
        }

        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { font-size: 0.8rem; color: var(--text-muted); }
        .input-group input, .input-group select {
            padding: 10px;
            border: 1px solid var(--border);
            background: var(--panel-bg);
            color: var(--text-main);
            border-radius: 6px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-primary:hover { opacity: 0.9; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border); color: var(--text-muted); font-size: 0.85rem; cursor: pointer; }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        tr:hover { background: var(--bg-color); }
        
        .rationale { font-style: italic; color: var(--text-muted); font-size: 0.8rem; }

        /* Modal for Trend Chart */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--panel-bg);
            padding: 30px;
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 15px; right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

    </style>
</head>
<body data-theme="dark">

    <div class="sidebar">
        <div class="brand">
            <span>‚ö° Metricsi</span>
        </div>
        <div class="nav-item active" onclick="switchPage('wizard')">
            <span>üëÅÔ∏è</span> Wizard Eye
        </div>
        <div class="nav-item" onclick="switchPage('fortune')">
            <span>üí∞</span> Fortune Manager
        </div>
    </div>

    <div class="main-content">
        
        <div class="top-bar">
            <div class="search-container">
                <input type="text" class="search-input" id="globalSearch" placeholder="Search Ticker (e.g., AAPL, TSLA)..." onkeyup="handleSearch(this.value)">
                <div class="suggestions" id="searchSuggestions"></div>
            </div>
            <div class="theme-toggle" onclick="toggleTheme()">
                <span id="bulbIcon">üí°</span>
            </div>
        </div>

        <div id="wizard" class="page active">
            <h1 id="stockTitle">Apple Inc. (AAPL)</h1>
            <div class="grid-container">
                <div class="card">
                    <h3>Fundamental Ratios</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div>
                            <span style="color:var(--text-muted); font-size:0.8rem;">P/E Ratio</span>
                            <div class="metric-value" id="peRatio">28.5</div>
                        </div>
                        <div>
                            <span style="color:var(--text-muted); font-size:0.8rem;">EPS</span>
                            <div class="metric-value" id="eps">6.42</div>
                        </div>
                        <div>
                            <span style="color:var(--text-muted); font-size:0.8rem;">Beta</span>
                            <div class="metric-value" id="beta">1.2</div>
                        </div>
                        <div>
                            <span style="color:var(--text-muted); font-size:0.8rem;">Div Yield</span>
                            <div class="metric-value" id="divYield">0.54%</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Cash Flow (TTM)</h3>
                    <div style="margin-top: 20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span>Operating CF</span>
                            <span style="font-weight:bold; color:var(--green)">$110.5B</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span>Free Cash Flow</span>
                            <span style="font-weight:bold; color:var(--accent)">$98.2B</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span>CapEx</span>
                            <span style="font-weight:bold; color:var(--red)">-$12.3B</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Analyst Consensus</h3>
                    <div style="text-align: center; margin: 20px 0;">
                        <span class="analyst-badge buy" id="ratingBadge">STRONG BUY</span>
                    </div>
                    <div style="font-size: 0.9rem; line-height: 1.6;">
                        Based on <strong>42</strong> analysts.<br>
                        Target Price: <strong style="color:var(--green)">$240.00</strong><br>
                        Upside: <strong>+15.2%</strong>
                    </div>
                </div>
            </div>
        </div>

        <div id="fortune" class="page">
            <h1>Fortune Manager</h1>
            
            <div class="card controls-panel">
                <div class="input-group">
                    <label>Tickers (comma sep)</label>
                    <input type="text" id="kellyTickers" value="AAPL, TSLA, NVDA, MSFT" style="width: 250px;">
                </div>
                <div class="input-group">
                    <label>Total Cash ($)</label>
                    <input type="number" id="kellyCash" value="100000">
                </div>
                <div class="input-group">
                    <label>Strategy</label>
                    <div style="display: flex; gap: 10px; align-items: center; height: 38px;">
                        <label><input type="radio" name="kellyMode" value="1" checked> Full Kelly</label>
                        <label><input type="radio" name="kellyMode" value="0.5"> Half</label>
                        <label><input type="radio" name="kellyMode" value="0.25"> Quarter</label>
                    </div>
                </div>
                <div class="input-group">
                    <label>Backtest Range</label>
                    <input type="date" id="dateStart" value="2023-01-01">
                </div>
                <div class="input-group">
                    <label>Backtest End</label>
                    <input type="date" id="dateEnd" value="2023-12-31">
                </div>
                <button class="btn-primary" onclick="runFortuneManager()">Run Allocation</button>
            </div>

            <div class="grid-container" style="grid-template-columns: 1fr 2fr;">
                <div class="card">
                    <h3>Allocation</h3>
                    <canvas id="allocationChart"></canvas>
                    <p style="text-align: center; font-size: 0.8rem; color: var(--text-muted); margin-top: 10px;">
                        Click a slice to view Trend Analysis
                    </p>
                </div>

                <div class="card">
                    <h3>Kelly Analysis Table</h3>
                    <div style="overflow-x: auto;">
                        <table id="kellyTable">
                            <thead>
                                <tr>
                                    <th onclick="sortTable(0)">Ticker</th>
                                    <th>Win Prob (p)</th>
                                    <th>Odds (b)</th>
                                    <th>Kelly %</th>
                                    <th>Cash Value</th>
                                    <th>Rationale</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="trendModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modalTickerTitle">Trend Analysis</h2>
            <div style="height: 400px;">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- MOCK DATABASE ---
        const stockDB = {
            'AAPL': { name: 'Apple Inc.', price: 185.50, pe: 28.5, eps: 6.42, beta: 1.2, div: '0.54%', cf: 98.2, rating: 'Strong Buy' },
            'TSLA': { name: 'Tesla Inc.', price: 240.20, pe: 65.2, eps: 3.10, beta: 2.1, div: '0.00%', cf: 4.5, rating: 'Hold' },
            'NVDA': { name: 'NVIDIA Corp', price: 650.00, pe: 85.1, eps: 4.80, beta: 1.7, div: '0.03%', cf: 18.0, rating: 'Buy' },
            'MSFT': { name: 'Microsoft', price: 405.00, pe: 36.4, eps: 10.3, beta: 0.9, div: '0.72%', cf: 65.0, rating: 'Buy' },
            'GOOG': { name: 'Alphabet', price: 145.00, pe: 24.1, eps: 5.80, beta: 1.05, div: '0.00%', cf: 70.0, rating: 'Buy' },
        };

        let currentChart = null;
        let trendChartInstance = null;
        let trendDataStore = {}; // Stores generated history

        // --- NAVIGATION ---
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // --- THEME TOGGLE ---
        function toggleTheme() {
            const body = document.body;
            const current = body.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', next);
            
            // Update chart colors if exists
            if(currentChart) currentChart.update();
        }

        // --- SEARCH BAR ---
        function handleSearch(query) {
            const suggestions = document.getElementById('searchSuggestions');
            suggestions.innerHTML = '';
            
            if (query.length < 1) {
                suggestions.style.display = 'none';
                return;
            }

            const keys = Object.keys(stockDB).filter(k => k.includes(query.toUpperCase()));
            
            if (keys.length > 0) {
                suggestions.style.display = 'block';
                keys.forEach(ticker => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerText = `${ticker} - ${stockDB[ticker].name}`;
                    div.onclick = () => loadStock(ticker);
                    suggestions.appendChild(div);
                });
            } else {
                suggestions.style.display = 'none';
            }
        }

        function loadStock(ticker) {
            document.getElementById('searchSuggestions').style.display = 'none';
            document.getElementById('globalSearch').value = ticker;
            
            // Update Wizard Eye Data
            const data = stockDB[ticker];
            if(data) {
                document.getElementById('stockTitle').innerText = `${data.name} (${ticker})`;
                document.getElementById('peRatio').innerText = data.pe;
                document.getElementById('eps').innerText = data.eps;
                document.getElementById('beta').innerText = data.beta;
                document.getElementById('divYield').innerText = data.div;
                document.getElementById('ratingBadge').innerText = data.rating.toUpperCase();
                
                // Switch to Wizard Page if not there
                switchPage('wizard');
                // Highlight nav
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                document.querySelectorAll('.nav-item')[1].classList.remove('active');
            }
        }

        // --- FORTUNE MANAGER LOGIC ---
        
        // 1. Helper: Generate Mock Price History for Backtesting
        function generateMockHistory(days) {
            let price = 100;
            let history = [];
            for(let i=0; i<days; i++) {
                // Random % change between -3% and +3.2% (slight upward bias)
                let change = (Math.random() * 0.062) - 0.03; 
                let prevPrice = price;
                price = price * (1 + change);
                history.push({
                    day: i,
                    price: price,
                    changePct: change,
                    isWin: change > 0
                });
            }
            return history;
        }

        // 2. Main Logic
        function runFortuneManager() {
            const tickers = document.getElementById('kellyTickers').value.toUpperCase().split(',').map(s => s.trim());
            const totalCash = parseFloat(document.getElementById('kellyCash').value);
            const kellyMultiplier = parseFloat(document.querySelector('input[name="kellyMode"]:checked').value);
            
            const tbody = document.querySelector('#kellyTable tbody');
            tbody.innerHTML = '';
            
            let allocationData = [];
            let totalAllocatedPct = 0;

            // Process each ticker
            tickers.forEach(ticker => {
                // Generate simulated backtest data (e.g., 252 trading days)
                const history = generateMockHistory(252); 
                trendDataStore[ticker] = history; // Store for the modal chart

                // Calculate Kelly Params
                const wins = history.filter(d => d.isWin);
                const losses = history.filter(d => !d.isWin);
                
                const p = wins.length / history.length; // Probability of win
                const q = 1 - p;
                
                const avgWin = wins.reduce((a,b) => a + b.changePct, 0) / wins.length;
                const avgLoss = Math.abs(losses.reduce((a,b) => a + b.changePct, 0) / losses.length);
                
                const b = avgWin / avgLoss; // Odds (Win size / Loss size)
                
                // Kelly Formula: f* = p - (q / b)
                let rawKelly = p - (q / b);
                
                // Apply User Multiplier (Full/Half/Quarter) and sanitize
                if (rawKelly < 0) rawKelly = 0; // No shorting in this tool
                let finalKelly = rawKelly * kellyMultiplier;
                
                allocationData.push({
                    ticker, p, b, finalKelly, rawKelly
                });
                totalAllocatedPct += finalKelly;
            });

            // Normalize if Total > 100% (Naive approach, usually we use leverage or scale down)
            // For this UI, we will scale down to 100% equity max, remainder is cash.
            let scaler = 1;
            if(totalAllocatedPct > 1) {
                scaler = 1 / totalAllocatedPct; // Scale down to fit 100%
            }

            // Render Table & Prepare Chart Data
            let chartLabels = [];
            let chartValues = [];
            let chartColors = [];

            allocationData.forEach(item => {
                const adjustedShare = item.finalKelly * scaler;
                const cashValue = adjustedShare * totalCash;
                
                const row = `<tr>
                    <td><strong>${item.ticker}</strong></td>
                    <td>${(item.p * 100).toFixed(1)}%</td>
                    <td>${item.b.toFixed(2)}</td>
                    <td>${(adjustedShare * 100).toFixed(1)}%</td>
                    <td>$${cashValue.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                    <td class="rationale">${getRationale(item.rawKelly)}</td>
                </tr>`;
                tbody.innerHTML += row;

                if(adjustedShare > 0) {
                    chartLabels.push(item.ticker);
                    chartValues.push(adjustedShare * 100);
                    chartColors.push(getColor(chartLabels.length));
                }
            });

            // Add Cash Slice
            const cashRemainingPct = 1 - (totalAllocatedPct * scaler);
            if(cashRemainingPct > 0.01) {
                chartLabels.push('CASH');
                chartValues.push(cashRemainingPct * 100);
                chartColors.push('#666666');
                
                tbody.innerHTML += `<tr style="background:rgba(0,0,0,0.02)">
                    <td><strong>CASH</strong></td>
                    <td>-</td><td>-</td>
                    <td>${(cashRemainingPct*100).toFixed(1)}%</td>
                    <td>$${(cashRemainingPct*totalCash).toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                    <td class="rationale">Unallocated Reserve</td>
                </tr>`;
            }

            renderPieChart(chartLabels, chartValues, chartColors);
        }

        function getRationale(k) {
            if(k <= 0) return "Negative expectancy or poor risk/reward.";
            if(k > 0.5) return "Extremely high conviction. High risk.";
            return "Positive expectancy based on trend.";
        }

        function getColor(index) {
            const colors = ['#2962ff', '#00c853', '#ffc107', '#d50000', '#aa00ff', '#00bcd4'];
            return colors[index % colors.length];
        }

        // --- CHARTS ---
        
        function renderPieChart(labels, data, colors) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            
            if (currentChart) currentChart.destroy();

            currentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    onClick: (evt, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const label = labels[index];
                            if(label !== 'CASH') openTrendModal(label);
                        }
                    },
                    plugins: {
                        legend: { position: 'right', labels: { color: getComputedStyle(document.body).getPropertyValue('--text-main') } }
                    }
                }
            });
        }

        // --- TREND MODAL ---
        function openTrendModal(ticker) {
            const modal = document.getElementById('trendModal');
            modal.style.display = 'flex';
            document.getElementById('modalTickerTitle').innerText = `Backtest Trend Analysis: ${ticker}`;
            
            const history = trendDataStore[ticker];
            renderTrendChart(history);
        }

        function closeModal() {
            document.getElementById('trendModal').style.display = 'none';
        }

        function renderTrendChart(history) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChartInstance) trendChartInstance.destroy();

            // Prepare segment colors for Green (Win) / Red (Loss)
            // Chart.js Line chart segment styling
            const prices = history.map(h => h.price);
            const labels = history.map(h => `Day ${h.day}`);

            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Price',
                        data: prices,
                        segment: {
                            borderColor: ctx => {
                                // Logic: If current point > previous, Green, else Red
                                if (ctx.p0.parsed.y < ctx.p1.parsed.y) return '#00c853'; // Up
                                return '#d50000'; // Down
                            }
                        },
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        x: { display: false },
                        y: { grid: { color: '#333' } }
                    }
                }
            });
        }

        // Initialize with default search
        loadStock('AAPL');
        
    </script>
</body>
</html>
